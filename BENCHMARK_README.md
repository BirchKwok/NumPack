# NumPack vs NumPy 性能基准测试

本测试套件提供了 NumPack 与 NumPy 在各个方面的全面性能对比。

## 测试内容

### 1. IO 性能测试
- **NumPack 保存/加载** vs **NumPy .npy** vs **NumPy .npz**
- 测试数据：1,000,000 行 × 100 列的 float32 数组（约 381MB）
- 包括普通加载和懒加载模式

### 2. 懒加载性能测试
- **NumPack 懒加载** vs **NumPy mmap_mode="r"** vs **NumPy memmap**
- 内存使用效率对比
- 访问速度对比

### 3. 随机访问性能测试
- 单个随机访问 vs 批量随机访问
- 测试10,000次随机索引访问
- 对比内存中访问 vs 磁盘映射访问

### 4. 非连续访问测试
- 步长访问（每隔200行）
- 倒序访问
- 斐波那契索引访问
- 测试不规则访问模式的性能

### 5. 流读取性能测试
- 按块读取大文件
- 默认块大小：10,000行
- 对比NumPack流式API vs NumPy分块读取

### 6. 批量操作测试
- 追加操作性能
- 替换操作性能
- 删除操作性能

### 7. 不同数据类型测试
- float32, float64, int32, int64, uint8
- 测试各种数据类型的保存/加载性能
- 文件大小对比

### 8. 大型矩阵运算测试
- 矩阵点积运算
- 内积运算
- 懒加载模式下的运算性能

### 9. 压缩效率测试
- 随机数据压缩
- 稀疏数据压缩（5%非零值）
- 重复模式数据压缩
- 压缩比对比

### 10. 内存效率测试
- 懒加载内存占用
- 完整加载内存占用
- 内存映射内存占用

## 使用方法

### 快速测试（推荐初次使用）
```bash
python run_benchmark.py --quick
```
- 使用较小的数据集（约5-10分钟）
- 数据规模：100,000行 × 50列

### 完整测试
```bash
python run_benchmark.py --full
```
- 使用完整的数据集（约30-60分钟）
- 数据规模：1,000,000行 × 100列

### 自定义输出文件
```bash
python run_benchmark.py --output my_benchmark.md
```

## 后端测试

测试会自动检测并测试以下后端：

1. **Python 后端** - 纯Python实现，跨平台兼容
2. **Rust 后端** - 高性能Rust实现（如果可用）

每个测试都会分别在两个后端上运行，提供详细的性能对比。

## 输出报告

测试完成后会生成详细的Markdown报告，包含：

- **测试环境信息**（Python版本、系统信息等）
- **详细性能数据表格**
- **性能总结**（最快操作、最佳压缩比等）
- **后端对比分析**

## 注意事项

1. **测试时间**：完整测试可能需要30-60分钟，建议先运行快速测试
2. **磁盘空间**：测试过程中会生成临时文件，需要约2-5GB可用空间
3. **内存要求**：建议至少4GB可用内存用于完整测试
4. **后端检测**：如果Rust后端不可用，会自动降级到Python后端

## 示例输出

```
开始全面性能基准测试
创建临时目录: /tmp/numpack_benchmark_xyz
开始 IO 性能测试 (数据大小: 1000000x100)
NumPack Save (python): 2.156s, 内存: 45.2MB
NumPack Load (python): 1.876s, 内存: 381.5MB
NumPack Lazy Load (python): 0.023s, 内存: 2.1MB
...

✅ 基准测试完成！
📊 详细报告已保存到: Benchmark.md
```

## 故障排除

### 导入错误
如果遇到导入错误，请确保：
1. 在NumPack项目根目录下运行脚本
2. 已正确安装NumPack包
3. Python路径设置正确

### 内存不足
如果遇到内存不足：
1. 使用 `--quick` 参数运行较小规模的测试
2. 关闭其他占用内存的程序
3. 检查可用内存是否大于4GB

### Rust后端不可用
这是正常情况，测试会自动使用Python后端。如需编译Rust后端：
```bash
pip install maturin
maturin develop --release
``` 